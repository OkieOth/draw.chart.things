<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SVG UI Prototype</title>
        <!-- Initialize default depth before any other scripts -->
        <script>
            window.defaultDepth = 2;
        </script>

        <script src="./js/htmx_1.9.12.min.js"></script>
        <script src="./js/wasm_exec.js"></script>
        <script src="./js/main.js"></script>
        <link
            rel="stylesheet"
            href="./css/font-awesome_6.5.1all.min.css"
            integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        />
        <link rel="stylesheet" href="./css/main.css" />
    </head>
    <body>
        <!-- Fixed menu (stays put during pan/zoom) -->
        <div id="menu">
            <strong>SVG Controls:</strong>
            <button title="Zoom +" hx-on:click="window.svgControls.zoom(1.2)">
                <i class="fa-solid fa-magnifying-glass-plus"></i>
            </button>
            <button title="Zoom -" hx-on:click="window.svgControls.zoom(1/1.2)">
                <i class="fa-solid fa-magnifying-glass-minus"></i>
            </button>
            <button
                title="Reset viewport"
                hx-on:click="window.svgControls.reset()"
            >
                <i class="fa-solid fa-rotate-left"></i>
            </button>
            <button
                title="Save current view"
                hx-on:click="window.svgControls.save()"
            >
                <i class="fa-solid fa-floppy-disk"></i>
            </button>
            <!-- Updated buttons with IDs and classes -->
            <button
                id="btn-minimap"
                class="tool-btn"
                hx-on:click="window.svgControls.toggleMinimap()"
                title="Toggle Minimap"
            >
                <i class="fa-solid fa-map"></i>
            </button>
            <button
                id="btn-collector"
                class="tool-btn"
                hx-on:click="window.svgControls.toggleCollector()"
                title="Toggle Expanded Box"
            >
                <i class="fa-solid fa-arrows-up-down"></i>
            </button>
            <!-- Blacklist tool toggle -->
            <button
                id="btn-blacklist"
                class="tool-btn"
                hx-on:click="window.svgControls.toggleBlacklist()"
                title="Blacklist Mode (Hide Objects)"
            >
                <i class="fa-solid fa-ban"></i>
            </button>
            <!-- Pan tool toggle -->
            <button
                id="btn-pan"
                class="tool-btn"
                hx-on:click="window.svgControls.togglePanTool()"
                title="Toggle Pan Tool"
            >
                <i class="fa-solid fa-arrows-up-down-left-right"></i>
            </button>
            <!-- Debug tool toggle -->
            <button
                id="btn-debug"
                class="tool-btn"
                hx-on:click="window.svgControls.toggleDebug()"
                title="Toggle Debug View"
            >
                <i class="fa-solid fa-bug"></i>
            </button>
            <!-- Combo box as last toolbar element -->
            <select id="toolbar-combo" style="margin-left: 8px">
                <option value="" selected>Default</option>
                <option value="conn1.yaml">Additional Connections 1</option>
                <option value="conn2.yaml">Additional Connections 2</option>
            </select>
            <!-- Permalink button -->
            <button
                id="btn-permalink"
                class="tool-btn"
                title="Create Permalink"
                style="margin-left: 8px"
            >
                <i class="fa-solid fa-link"></i>
            </button>
            <!-- Expand All button -->
            <button
                id="btn-expand-all"
                class="tool-btn"
                title="Expand All (Show All Non-Blacklisted)"
                style="margin-left: 8px"
            >
                <i class="fa-solid fa-expand"></i>
            </button>
        </div>

        <!-- Minimap -->
        <div id="minimap" aria-hidden="true" style="display: none">
            <svg
                id="minimap-svg"
                viewBox="0 0 100 100"
                preserveAspectRatio="xMidYMid meet"
            >
                <!-- Scene outline -->
                <rect
                    id="minimap-scene"
                    x="0"
                    y="0"
                    width="100"
                    height="100"
                    fill="none"
                    stroke="#bbb"
                />
                <!-- Preview of content -->
                <g id="minimap-content"></g>
                <!-- Viewport rectangle -->
                <rect
                    id="minimap-vp"
                    class="vp"
                    x="0"
                    y="0"
                    width="10"
                    height="10"
                />
            </svg>
        </div>

        <!-- Badge collector box (now left side) -->
        <div
            id="collector"
            class="hidden"
            aria-live="polite"
            aria-hidden="true"
        >
            <div class="title">Expanded Items</div>
            <div id="badge-list"></div>
        </div>

        <!-- Blacklist collector box (left side, below expanded) -->
        <div
            id="blacklist-collector"
            class="hidden"
            aria-live="polite"
            aria-hidden="true"
        >
            <div class="title">Blacklisted Items</div>
            <div id="blacklist-list"></div>
        </div>

        <div id="canvas">
            <!-- ...existing code... -->
            <!-- SVG will be loaded here via boxes.wasm -->
            <!-- ...existing code... -->
        </div>

        <!-- Global loading spinner overlay -->
        <div id="spinner" class="hidden" aria-hidden="true">
            <div class="spinner-backdrop"></div>
            <div class="spinner-content" role="status" aria-live="polite">
                <i class="fa-solid fa-circle-notch fa-spin"></i>
                <span>Loadingâ€¦</span>
            </div>
        </div>

        <!-- Permalink popup -->
        <div
            id="permalink-popup"
            class="hidden"
            tabindex="-1"
            aria-modal="true"
            role="dialog"
            style="
                position: fixed;
                top: 30%;
                left: 50%;
                transform: translate(-50%, -30%);
                background: #fff;
                border: 1px solid #888;
                padding: 1.5em;
                z-index: 1000;
                box-shadow: 0 2px 16px #0002;
                min-width: 320px;
                display: none;
            "
        >
            <div style="margin-bottom: 0.5em; font-weight: bold">Permalink</div>
            <input
                id="permalink-url"
                type="text"
                readonly
                style="width: 100%; margin-bottom: 0.5em; font-size: 1em"
            />
            <button id="permalink-copy-btn" style="width: 100%">
                <i class="fa-solid fa-copy"></i> Copy Link
            </button>
        </div>

        <script>
            window.initPage();
            window.handleInputQueryParam();
            window.loadYamlInput();
            window.loadSVGFromWasm();

            // Expand All logic
            (function () {
                const btnExpandAll = document.getElementById("btn-expand-all");
                if (!btnExpandAll) return;
                btnExpandAll.addEventListener("click", function () {
                    if (
                        !window.getAllBoxIds ||
                        !window.applyBadgeState ||
                        !window.reloadSvgFromBadges
                    ) {
                        alert(
                            "Expand All is not available: missing required functions.",
                        );
                        return;
                    }
                    // Get all box ids, filter out blacklisted
                    const allBoxIds = window.getAllBoxIds();
                    const blacklist =
                        window.blacklist && Array.isArray(window.blacklist)
                            ? window.blacklist
                            : window.blacklist || [];
                    const toExpand = allBoxIds.filter(
                        (id) => !blacklist.includes(id),
                    );
                    // Build badge state objects
                    const badgeState = toExpand.map((id) => ({
                        id: "",
                        hid: id,
                    }));
                    window.applyBadgeState(badgeState);
                    window.reloadSvgFromBadges(true);
                });
            })();

            // Permalink logic
            (function () {
                const btn = document.getElementById("btn-permalink");
                const popup = document.getElementById("permalink-popup");
                const urlInput = document.getElementById("permalink-url");
                const copyBtn = document.getElementById("permalink-copy-btn");
                // Helper to get expanded/blacklisted ids (assume global functions or arrays)
                function getExpandedIds() {
                    // Return the data-hid of all badges in #badge-list
                    const list = document.getElementById("badge-list");
                    if (!list) return [];
                    return Array.from(list.querySelectorAll(".badge"))
                        .map((b) => b.dataset.hid)
                        .filter(Boolean);
                }
                function getBlacklistedIds() {
                    // Return the data-hid of all badges in #blacklist-list
                    const list = document.getElementById("blacklist-list");
                    if (!list) return [];
                    return Array.from(list.querySelectorAll(".badge"))
                        .map((b) => b.dataset.hid)
                        .filter(Boolean);
                }
                function getInputVar() {
                    // Use the currently loaded YAML filename if available
                    if (window.currentYamlFile) return window.currentYamlFile;
                    if (window.input) return window.input;
                    const el = document.getElementById("input");
                    return el ? el.value : "";
                }
                function getComboValue() {
                    const sel = document.getElementById("toolbar-combo");
                    return sel ? sel.value : "";
                }
                function makePermalink() {
                    const params = new URLSearchParams();
                    // Always include the original 'input' query parameter if present in the URL
                    const origInput = (function () {
                        const urlParams = new URLSearchParams(
                            window.location.search,
                        );
                        return urlParams.has("input")
                            ? urlParams.get("input")
                            : "";
                    })();
                    if (origInput) params.set("input", origInput);
                    const combo = getComboValue();
                    if (combo) {
                        params.set("combo", combo);
                    }
                    const expanded = getExpandedIds();
                    if (expanded && expanded.length)
                        params.set("expandedIds", expanded.join(","));
                    const blacklisted = getBlacklistedIds();
                    if (blacklisted && blacklisted.length)
                        params.set("blacklistedIds", blacklisted.join(","));
                    return (
                        window.location.origin +
                        window.location.pathname +
                        "?" +
                        params.toString()
                    );
                }
                function showPopup(link) {
                    urlInput.value = link;
                    popup.classList.remove("hidden");
                    popup.style.display = "block";
                    urlInput.focus();
                    urlInput.select();
                }
                function hidePopup() {
                    popup.classList.add("hidden");
                    popup.style.display = "none";
                }
                btn.addEventListener("click", function () {
                    const link = makePermalink();
                    showPopup(link);
                });
                copyBtn.addEventListener("click", function () {
                    urlInput.select();
                    document.execCommand("copy");
                    hidePopup();
                });
                // Hide popup on ESC
                popup.addEventListener("keydown", function (e) {
                    if (e.key === "Escape") {
                        hidePopup();
                    }
                });
                // Hide popup if clicking outside
                document.addEventListener("mousedown", function (e) {
                    if (
                        !popup.classList.contains("hidden") &&
                        !popup.contains(e.target) &&
                        e.target !== btn
                    ) {
                        hidePopup();
                    }
                });
            })();
        </script>
    </body>
</html>
